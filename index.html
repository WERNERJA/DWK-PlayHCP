<script type="text/javascript">
  const { useState, useEffect } = React;

  function roundHalfUp(x) {
    const factor = 1;
    const abs = Math.abs(x);
    const intPart = Math.floor(abs);
    const frac = abs - intPart;
    let rounded;
    if (frac > 0.5) rounded = intPart + 1;
    else if (frac < 0.5) rounded = intPart;
    else rounded = intPart + 1;
    return x < 0 ? -rounded : rounded;
  }

  function computePlayingHandicap(hi, par, cr, sr, allowance = 1.0, lus = '') {
    const ch = hi * (sr / 113.0) + (cr - par);
    let ph = ch * allowance;

    // ✅ Aanpassing: halveer de playing handicap voor 9-holes lussen
    if (lus.startsWith('9_')) {
      ph = ph / 2;
    }

    return roundHalfUp(ph);
  }

  const TEE_OPTIONS = {
    heer: [
      { key: 'wit', label: 'Wit', colorClass: 'bg-gray-800' },
      { key: 'geel', label: 'Geel', colorClass: 'bg-yellow-500' },
      { key: 'blauw', label: 'Blauw', colorClass: 'bg-blue-500' },
      { key: 'rood', label: 'Rood', colorClass: 'bg-red-500' },
      { key: 'oranje', label: 'Oranje', colorClass: 'bg-orange-500' },
    ],
    dame: [
      { key: 'geel', label: 'Geel', colorClass: 'bg-yellow-500' },
      { key: 'blauw', label: 'Blauw', colorClass: 'bg-blue-500' },
      { key: 'rood', label: 'Rood', colorClass: 'bg-red-500' },
      { key: 'oranje', label: 'Oranje', colorClass: 'bg-orange-500' },
    ]
  };

  const LUS_OPTIONS = [
    { key: '18', label: '18 holes' },
    { key: '9_watertoren', label: '9 holes Watertoren' },
    { key: '9_grote_kreek', label: '9 holes De Grote Kreek' },
  ];

  function App() {
    const [step, setStep] = useState(1);
    const [hi, setHi] = useState('');
    const [gender, setGender] = useState('');
    const [tee, setTee] = useState('');
    const [lus, setLus] = useState('');
    const [data, setData] = useState(null);
    const [loadingData, setLoadingData] = useState(true);
    const [error, setError] = useState('');
    const [result, setResult] = useState(null);

    useEffect(() => {
      setLoadingData(true);
      fetch('dwk-course-data.json')
        .then(res => {
          if (!res.ok) throw new Error('Kon dwk-course-data.json niet laden');
          return res.json();
        })
        .then(json => {
          setData(json);
          setLoadingData(false);
        })
        .catch(err => {
          setError(err.message);
          setLoadingData(false);
        });
    }, []);

    useEffect(() => {
      const el = document.getElementById('qr');
      if (!el) return;
      el.innerHTML = '';
      try {
        new QRCode(el, { text: window.location.href, width: 96, height: 96 });
      } catch (e) {}
    }, [step]);

    function goToStep2() {
      setError('');
      const val = parseFloat(hi);
      if (isNaN(val) || val < -10 || val > 54) {
        setError('Geef een geldige handicap index (bv. 14.3).');
        return;
      }
      if (!gender) {
        setError('Kies het geslacht (Heer of Dame).');
        return;
      }
      if (loadingData) {
        setError('Wacht tot dwk-course-data.json geladen is (even de pagina verversen als dit lang duurt).');
        return;
      }
      if (!data) {
        setError('dwk-course-data.json kon niet geladen worden. Controleer netwerk of bestand.');
        return;
      }
      setStep(2);
    }

    function performCompute() {
      setError('');
      if (!tee || !lus) {
        setError('Kies een tee-box en een lus.');
        return;
      }
      if (lus.includes('kleine')) {
        setError('De Kleine Kreek wordt niet ondersteund.');
        return;
      }
      const g = data?.[gender];
      const t = g?.[tee];
      const seg = t?.[lus];
      if (!seg) {
        setError(`Ontbrekende course-parameters voor deze combinatie: ${gender}/${tee}/${lus}. Controleer dwk-course-data.json.`);
        return;
      }
      const par = Number(seg.par);
      const cr = Number(seg.cr);
      const sr = Number(seg.sr);
      const hiVal = parseFloat(hi);
      if ([par, cr, sr].some(v => Number.isNaN(v))) {
        setError('Onjuiste parameterwaarden in dwk-course-data.json voor deze combinatie.');
        return;
      }

      // ✅ Lus meegeven aan computePlayingHandicap
      const ph = computePlayingHandicap(hiVal, par, cr, sr, 1.0, lus);
      setResult({ ph, par, cr, sr });
      setStep(3);
    }

    function resetAll() {
      setStep(1);
      setHi('');
      setGender('');
      setTee('');
      setLus('');
      setError('');
      setResult(null);
    }

    // ... rest van de render logica blijft ongewijzigd ...
  }

  const root = ReactDOM.createRoot(document.getElementById('app'));
  root.render(React.createElement(App));
</script>
